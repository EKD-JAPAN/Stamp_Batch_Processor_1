<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBayå¯¾å¿œã‚¹ã‚¿ãƒ³ãƒ—åˆæˆãƒ„ãƒ¼ãƒ« (ä¸€æ‹¬å‡¦ç†/é€éPNG)</title>
    <!-- Tailwind CSSã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 'Inter'ãƒ•ã‚©ãƒ³ãƒˆã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ã—ã€å…¨ä½“ã‚’ãƒ¢ãƒ€ãƒ³ã« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* éå¸¸ã«æ˜ã‚‹ã„ã‚ªãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆ */
        }
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®å½±ã‚’å¼·èª¿ */
        .main-card {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Canvasã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        .canvas-container {
            width: 100%;
            padding-bottom: 75%; /* 4:3 Aspect Ratio (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç¸¦æ¨ªæ¯”ã®ç›®å®‰) */
            position: relative;
            overflow: hidden;
        }
        #imageCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            object-fit: contain; /* ç”»åƒã‚’Canvasã‚µã‚¤ã‚ºã«åã‚ã‚‹ */
        }
        /* é…ç½®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .position-button {
            @apply flex items-center justify-center h-10 border border-slate-300 rounded-lg text-slate-600 bg-white hover:bg-slate-50 transition;
        }
        .position-button.active {
            @apply bg-indigo-600 text-white border-indigo-600 shadow-md ring-4 ring-indigo-200;
        }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        input[type="file"]::file-selector-button {
            @apply cursor-pointer mr-3 py-2 px-4 rounded-full border-0 text-sm font-semibold bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition duration-150;
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¦‹ãŸç›®ã‚’èª¿æ•´ */
        input[type=range]::-webkit-slider-thumb {
            @apply appearance-none w-4 h-4 bg-indigo-600 rounded-full cursor-pointer shadow-lg;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased p-4 sm:p-8">
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ - ä¸­å¤®ã«é…ç½®ã•ã‚Œã€æœ€å¤§å¹…ã‚’è¨­å®š -->
    <div class="max-w-7xl mx-auto w-full bg-white main-card rounded-3xl p-6 sm:p-10 border border-slate-100">
        
        <header class="pb-6 border-b border-indigo-100 mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-800 tracking-tight">
                ğŸ–¼ï¸ Image Stamp Batch Processor
            </h1>
            <p class="text-slate-500 mt-2">
                eBayã®å•†å“ç”»åƒã«è¤‡æ•°ã®ãƒ­ã‚´/ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é‡ã­ã¦ä¸€æ‹¬å‡¦ç†ã—ã¾ã™ã€‚ï¼ˆé€éPNGå¯¾å¿œï¼‰
            </p>
        </header>
        
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <!-- 1. è¨­å®šãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« (å·¦ã‚µã‚¤ãƒ‰) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 1. ãƒ™ãƒ¼ã‚¹ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div class="p-5 bg-slate-50 rounded-xl border border-slate-200">
                    <label class="block text-xl font-bold text-slate-800 mb-3">
                        1. ãƒ™ãƒ¼ã‚¹ç”»åƒ (å•†å“ç”»åƒ)
                    </label>
                    <input type="file" id="imageUpload" accept="image/jpeg,image/png,image/webp" multiple 
                           class="w-full text-sm text-slate-600">
                    <p id="uploadStatus" class="text-sm text-red-500 mt-2 hidden">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <!-- 2. ãƒ­ã‚´/ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®š -->
                <div class="p-5 bg-white rounded-xl shadow-lg border border-slate-200 space-y-4">
                    <h3 class="text-xl font-bold text-slate-800 border-b pb-2 mb-4">2. ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®š</h3>
                    
                    <!-- ãƒ­ã‚´ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-600">ãƒ­ã‚´ç”»åƒ (é€éPNGæ¨å¥¨)</label>
                        <input type="file" id="logoUpload" accept="image/png,image/gif"
                               class="w-full text-sm text-slate-600">
                        <p id="currentLogoStatus" class="text-xs mt-1 hidden"></p>
                    </div>

                    <!-- é…ç½®ãƒã‚¸ã‚·ãƒ§ãƒ³é¸æŠ -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-600">é…ç½®ãƒã‚¸ã‚·ãƒ§ãƒ³:</label>
                        <div id="positionButtons" class="grid grid-cols-2 gap-3">
                            <button data-pos="top-left" class="position-button">å·¦ä¸Š</button>
                            <button data-pos="top-right" class="position-button active">å³ä¸Š</button>
                            <button data-pos="bottom-left" class="position-button">å·¦ä¸‹</button>
                            <button data-pos="bottom-right" class="position-button">å³ä¸‹</button>
                        </div>
                    </div>

                    <!-- ã‚µã‚¤ã‚ºèª¿æ•´ -->
                    <div class="pt-2 space-y-2">
                        <label for="sizeRatio" class="block text-sm font-semibold text-slate-600">
                            ãƒ­ã‚´é¢ç©æ¯”: <span id="currentRatio" class="font-bold text-indigo-600">1/15</span> 
                            <span class="text-xs text-slate-400">(1/4 ï½ 1/30)</span>
                        </label>
                        <input type="range" id="sizeRatio" min="4" max="30" value="15" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <button id="addStampButton" 
                            class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition disabled:opacity-50 mt-4"
                            disabled>
                        ã‚¹ã‚¿ãƒ³ãƒ—ãƒªã‚¹ãƒˆã«è¿½åŠ  ğŸš€
                    </button>
                </div>
            </div>
            
            <!-- 2. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ (å³ã‚µã‚¤ãƒ‰) -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="p-5 bg-white rounded-xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800 mb-3">
                        ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ 
                        <span class="text-sm font-medium text-indigo-600 ml-2">
                            (<span id="previewIndex">0</span> / <span id="totalImages">0</span>)
                        </span>
                    </h3>
                    
                    <!-- ç”»åƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                    <div class="flex justify-between items-center mb-3 space-x-2">
                        <button id="prevImageButton" class="w-1/2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition disabled:opacity-30 text-sm font-medium">
                            <span class="mr-1">â†</span> å‰ã®ç”»åƒ
                        </button>
                        <button id="nextImageButton" class="w-1/2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition disabled:opacity-30 text-sm font-medium">
                            æ¬¡ã®ç”»åƒ <span class="ml-1">â†’</span>
                        </button>
                    </div>

                    <!-- å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ (NEW) -->
                    <button id="downloadCurrentImageButton" 
                            class="w-full px-4 py-2 mb-3 bg-indigo-500 text-white font-bold rounded-lg shadow hover:bg-indigo-600 transition disabled:opacity-30 text-sm"
                            disabled>
                        ç¾åœ¨ã®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (.jpg)
                    </button>

                    <div class="canvas-container shadow-xl rounded-lg overflow-hidden border border-slate-300">
                        <canvas id="imageCanvas"></canvas>
                        <p id="canvasPlaceholder" class="absolute inset-0 flex items-center justify-center text-slate-400 text-lg bg-gray-50/80">
                            ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                        </p>
                    </div>
                </div>

                <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ -->
                <div class="p-5 bg-white rounded-xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800 mb-3 border-b pb-2">é©ç”¨ã‚¹ã‚¿ãƒ³ãƒ—ãƒªã‚¹ãƒˆ</h3>
                    <div id="activeStampsList" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ã‚¿ãƒ³ãƒ—ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        <p class="text-slate-400 text-sm">ç¾åœ¨ã€é©ç”¨ã™ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                    <button id="clearStampsButton" class="mt-4 text-red-500 hover:text-red-600 text-sm font-medium p-1 rounded-md hover:bg-red-50 transition">ãƒªã‚¹ãƒˆã‚’å…¨ã¦ã‚¯ãƒªã‚¢</button>
                </div>

                <!-- 4. ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
                <div class="p-5 bg-green-50 rounded-xl border border-green-200">
                    <button id="downloadAllButton" 
                            class="w-full px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-xl shadow-xl hover:bg-green-700 transition duration-300 disabled:opacity-50"
                            disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v8a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        å…¨ã¦ã®ç”»åƒã‚’ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (.zip)
                    </button>
                    <p id="downloadProgress" class="text-sm text-slate-600 mt-3 text-center hidden font-medium"></p>
                </div>
            </div>
            
        </main>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
        <footer class="mt-10 pt-6 border-t border-slate-100 text-center">
            <p class="text-xs text-slate-400">
                ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ç”»åƒå‡¦ç†ã‚’è¡Œã†ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“ã€‚
            </p>
        </footer>
        
    </div>

    <!-- JSZip Library for Zipping Files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- JavaScript - ç”»åƒå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // --- DOMè¦ç´ ã¨åˆæœŸè¨­å®š ---
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const imageUpload = document.getElementById('imageUpload');
        const logoUpload = document.getElementById('logoUpload');
        const addStampButton = document.getElementById('addStampButton');
        const downloadAllButton = document.getElementById('downloadAllButton');
        const downloadCurrentImageButton = document.getElementById('downloadCurrentImageButton'); // NEW
        const positionButtons = document.getElementById('positionButtons');
        const sizeRatioInput = document.getElementById('sizeRatio');
        const currentRatioSpan = document.getElementById('currentRatio');
        const activeStampsList = document.getElementById('activeStampsList');
        const clearStampsButton = document.getElementById('clearStampsButton');
        const downloadProgress = document.getElementById('downloadProgress');
        const totalImagesSpan = document.getElementById('totalImages');
        const previewIndexSpan = document.getElementById('previewIndex');
        const canvasPlaceholder = document.getElementById('canvasPlaceholder');
        const currentLogoStatus = document.getElementById('currentLogoStatus');
        const prevImageButton = document.getElementById('prevImageButton');
        const nextImageButton = document.getElementById('nextImageButton');

        // --- çŠ¶æ…‹ç®¡ç†å¤‰æ•° ---
        let baseImages = []; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå…¨ã¦ã®ãƒ™ãƒ¼ã‚¹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
        let loadedLogoImage = null; // ç¾åœ¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ãƒ­ã‚´ç”»åƒ (Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
        let activeStamps = []; // é©ç”¨ã™ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®šã®ãƒªã‚¹ãƒˆ
        let currentPosition = 'top-right'; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒã‚¸ã‚·ãƒ§ãƒ³ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
        let currentPreviewIndex = 0; // ç¾åœ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã„ã‚‹ç”»åƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (0-based)

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        /**
         * é¢ç©æ¯”ç‡ã«åŸºã¥ãã€ãƒ­ã‚´ã®åˆæˆå¾Œã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã™ã‚‹
         * @param {number} baseWidth ãƒ™ãƒ¼ã‚¹ç”»åƒã®å¹…
         * @param {number} baseHeight ãƒ™ãƒ¼ã‚¹ç”»åƒã®é«˜ã•
         * @param {number} logoOriginalWidth ãƒ­ã‚´ã®å…ƒã®å¹…
         * @param {number} logoOriginalHeight ãƒ­ã‚´ã®å…ƒã®é«˜ã•
         * @param {number} ratio é¢ç©æ¯”ç‡ã®åˆ†æ¯ (ä¾‹: 15 for 1/15)
         * @returns {{width: number, height: number}} åˆæˆå¾Œã®å¹…ã¨é«˜ã•
         */
        function calculateLogoDimensions(baseWidth, baseHeight, logoOriginalWidth, logoOriginalHeight, ratio) {
            if (logoOriginalWidth <= 0 || logoOriginalHeight <= 0 || ratio < 1) {
                return { width: 0, height: 0 };
            }
            
            const A_base = baseWidth * baseHeight;
            const A_logo = A_base / ratio; // ç›®æ¨™ãƒ­ã‚´é¢ç©

            const logo_aspect = logoOriginalWidth / logoOriginalHeight;

            // W^2 / aspect = A_logo  -> W^2 = A_logo * aspect -> W = sqrt(A_logo * aspect)
            const W_stamp = Math.sqrt(A_logo * logo_aspect);
            
            // H = W / aspect
            const H_stamp = W_stamp / logo_aspect;
            
            return { width: W_stamp, height: H_stamp };
        }

        /**
         * ãƒ­ã‚´ã®é…ç½®åº§æ¨™ã‚’è¨ˆç®—ã™ã‚‹ (è¤‡æ•°ãƒ­ã‚´å¯¾å¿œ)
         * @param {number} canvasWidth Canvasã®å¹…
         * @param {number} canvasHeight Canvasã®é«˜ã•
         * @param {{width: number, height: number}} logoDimensions ãƒ­ã‚´ã®ã‚µã‚¤ã‚º
         * @param {string} position é…ç½® ('top-left', 'top-right', 'bottom-left', 'bottom-right')
         * @param {number} index ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (0, 1, 2...)
         * @returns {{x: number, y: number}} é…ç½®åº§æ¨™
         */
        function calculatePosition(canvasWidth, canvasHeight, logoDimensions, position, index) {
            const { width: stampWidth, height: stampHeight } = logoDimensions;
            // ç”»é¢ã®çŸ­ã„è¾ºã®3%ã‚’ãƒãƒ¼ã‚¸ãƒ³ã¨ã™ã‚‹
            const margin = Math.min(canvasWidth, canvasHeight) * 0.03; 

            let x, y;
            
            // è¤‡æ•°ã®ãƒ­ã‚´ã‚’æ¨ªã«ä¸¦ã¹ã‚‹å ´åˆã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            let offsetX = index * (stampWidth + (margin / 2)); // ãƒ­ã‚´å¹… + ã‚ãšã‹ãªé–“éš”
            
            switch (position) {
                case 'top-left':
                    x = margin + offsetX;
                    y = margin;
                    break;
                case 'top-right':
                    // å³ç«¯ã‹ã‚‰é…ç½®é–‹å§‹
                    x = canvasWidth - stampWidth - margin - offsetX; 
                    y = margin;
                    break;
                case 'bottom-left':
                    x = margin + offsetX;
                    y = canvasHeight - stampHeight - margin;
                    break;
                case 'bottom-right':
                    // å³ç«¯ã‹ã‚‰é…ç½®é–‹å§‹
                    x = canvasWidth - stampWidth - margin - offsetX;
                    y = canvasHeight - stampHeight - margin;
                    break;
            }
            return { x, y };
        }

        /**
         * Canvasã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ™ãƒ¼ã‚¹ç”»åƒã¨å…¨ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æç”»ã™ã‚‹
         * @param {Image} baseImg - ãƒ™ãƒ¼ã‚¹ç”»åƒ
         */
        function drawCanvas(baseImg) {
            if (!baseImg) return;

            // Canvasã‚µã‚¤ã‚ºã‚’ãƒ™ãƒ¼ã‚¹ç”»åƒã«åˆã‚ã›ã‚‹
            canvas.width = baseImg.width;
            canvas.height = baseImg.height;

            // 1. ãƒ™ãƒ¼ã‚¹ç”»åƒã‚’å…¨é¢ã«æç”»
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);

            if (activeStamps.length === 0) return;

            // 2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ã‚¿ãƒ³ãƒ—ã‚’æç”»
            const stampsByPosition = {};
            
            // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒã‚¸ã‚·ãƒ§ãƒ³ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            activeStamps.forEach(stamp => {
                if (!stampsByPosition[stamp.position]) {
                    stampsByPosition[stamp.position] = [];
                }
                stampsByPosition[stamp.position].push(stamp);
            });

            // ãƒã‚¸ã‚·ãƒ§ãƒ³ã”ã¨ã«ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŒ¯ã‚Šç›´ã—ã¦é…ç½®
            Object.values(stampsByPosition).forEach(stamps => {
                stamps.forEach((stamp, index) => {
                    const logoOriginalWidth = stamp.image.width;
                    const logoOriginalHeight = stamp.image.height;
                    
                    // ã‚µã‚¤ã‚ºã¨ãƒã‚¸ã‚·ãƒ§ãƒ³ã®è¨ˆç®—
                    const dims = calculateLogoDimensions(
                        canvas.width, 
                        canvas.height, 
                        logoOriginalWidth, 
                        logoOriginalHeight, 
                        stamp.ratio
                    );
                    
                    const pos = calculatePosition(
                        canvas.width, 
                        canvas.height, 
                        dims, 
                        stamp.position, 
                        index // åŒã˜ãƒã‚¸ã‚·ãƒ§ãƒ³å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                    );

                    // 3. Canvasã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æç”»
                    ctx.drawImage(stamp.image, pos.x, pos.y, dims.width, dims.height);
                });
            });
        }
        
        /**
         * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã™ã‚‹
         */
        function updatePreview() {
            // UIä¸Šã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            totalImagesSpan.textContent = baseImages.length;
            previewIndexSpan.textContent = baseImages.length > 0 ? currentPreviewIndex + 1 : 0;
            
            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
            const isImageLoaded = baseImages.length > 0;
            const isStampActive = activeStamps.length > 0;
            
            prevImageButton.disabled = currentPreviewIndex <= 0 || !isImageLoaded;
            nextImageButton.disabled = currentPreviewIndex >= baseImages.length - 1 || !isImageLoaded;
            
            // å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã¨ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–
            downloadCurrentImageButton.disabled = !(isImageLoaded && isStampActive);
            downloadAllButton.disabled = !(isImageLoaded && isStampActive);


            if (isImageLoaded) {
                // currentPreviewIndexã«åŸºã¥ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                const file = baseImages[currentPreviewIndex]; 
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        drawCanvas(img);
                        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«
                        canvasPlaceholder.classList.add('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                // ç”»åƒãŒãªã„å ´åˆ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Canvasã®åˆæœŸã‚µã‚¤ã‚ºã‚’å¾©å…ƒ
                canvas.width = 600; 
                canvas.height = 450;
                canvasPlaceholder.classList.remove('hidden');
            }
        }
        
        /**
         * ã‚¹ã‚¿ãƒ³ãƒ—ãƒªã‚¹ãƒˆã®UIã‚’æ›´æ–°ã™ã‚‹
         */
        function updateStampListUI() {
            activeStampsList.innerHTML = '';
            if (activeStamps.length === 0) {
                activeStampsList.innerHTML = '<p class="text-slate-400 text-sm p-2">ã‚¹ã‚¿ãƒ³ãƒ—ãŒãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
            } else {
                activeStamps.forEach((stamp, index) => {
                    const ratioDisplay = `1/${stamp.ratio}`;
                    const positionDisplay = {
                        'top-left': 'å·¦ä¸Š',
                        'top-right': 'å³ä¸Š',
                        'bottom-left': 'å·¦ä¸‹',
                        'bottom-right': 'å³ä¸‹'
                    }[stamp.position] || stamp.position;

                    const li = document.createElement('div');
                    li.className = 'flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-200';
                    li.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${stamp.image.src}" class="w-10 h-10 object-contain rounded-md border p-1 bg-white" alt="ã‚¹ã‚¿ãƒ³ãƒ—">
                            <div>
                                <p class="font-medium text-slate-700">ã‚¹ã‚¿ãƒ³ãƒ— #${index + 1}</p>
                                <p class="text-xs text-slate-500">ä½ç½®: ${positionDisplay} / ã‚µã‚¤ã‚º: ${ratioDisplay}</p>
                            </div>
                        </div>
                        <button data-index="${index}" class="remove-stamp-button text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    activeStampsList.appendChild(li);
                });
            }


            // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
            document.querySelectorAll('.remove-stamp-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    activeStamps.splice(index, 1);
                    updateStampListUI();
                });
            });

            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã‚’æ›´æ–°
            updatePreview();
        }

        /**
         * ç¾åœ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ç”»åƒã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é©ç”¨ã—ã€å˜ä½“ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         */
        async function downloadCurrentStampedImage() {
            if (baseImages.length === 0 || activeStamps.length === 0) return;

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            downloadCurrentImageButton.disabled = true;
            downloadAllButton.disabled = true;
            downloadProgress.textContent = 'â³ ç¾åœ¨ã®ç”»åƒã‚’å‡¦ç†ä¸­...';
            downloadProgress.classList.remove('hidden');

            const file = baseImages[currentPreviewIndex];
            const fileName = file.name.replace(/\.[^/.]+$/, ""); // æ‹¡å¼µå­ãªã—ã®ãƒ•ã‚¡ã‚¤ãƒ«å

            try {
                // 1. ãƒ™ãƒ¼ã‚¹ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰
                const baseImg = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = () => reject(new Error('Image load failed'));
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });

                // 2. ä»®æƒ³Canvasã‚’ä½œæˆã—ã€åˆæˆå‡¦ç†ã‚’è¡Œã† (ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯)
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = baseImg.width;
                tempCanvas.height = baseImg.height;

                // ãƒ™ãƒ¼ã‚¹ç”»åƒã‚’æç”»
                tempCtx.drawImage(baseImg, 0, 0, tempCanvas.width, tempCanvas.height);

                // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é©ç”¨
                const stampsByPosition = {};
                activeStamps.forEach(stamp => {
                    if (!stampsByPosition[stamp.position]) {
                        stampsByPosition[stamp.position] = [];
                    }
                    stampsByPosition[stamp.position].push(stamp);
                });

                Object.values(stampsByPosition).forEach(stamps => {
                    stamps.forEach((stamp, index) => {
                        const logoOriginalWidth = stamp.image.width;
                        const logoOriginalHeight = stamp.image.height;
                        
                        const dims = calculateLogoDimensions(
                            tempCanvas.width, 
                            tempCanvas.height, 
                            logoOriginalWidth, 
                            logoOriginalHeight, 
                            stamp.ratio
                        );
                        
                        const pos = calculatePosition(
                            tempCanvas.width, 
                            tempCanvas.height, 
                            dims, 
                            stamp.position, 
                            index 
                        );

                        tempCtx.drawImage(stamp.image, pos.x, pos.y, dims.width, dims.height);
                    });
                });

                // 3. ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (JPEGå½¢å¼)
                const dataURL = tempCanvas.toDataURL('image/jpeg', 0.9);
                const link = document.createElement('a');
                link.href = dataURL;
                
                // --- ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–° ---
                const stampCount = activeStamps.length;
                // ã‚¹ã‚¿ãƒ³ãƒ—ãŒ1ã¤ãªã‚‰ "_stamp", è¤‡æ•°ãªã‚‰ "_stamps"
                const stampSuffix = stampCount === 1 ? '_stamp' : (stampCount > 1 ? '_stamps' : ''); 
                link.download = `${fileName}${stampSuffix}.jpg`;
                // ------------------------------------

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                downloadProgress.textContent = `âœ… ${fileName}${stampSuffix}.jpg ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼`;

            } catch (error) {
                console.error(`ç”»åƒ ${file.name} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
                downloadProgress.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ä¸­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            } finally {
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                downloadCurrentImageButton.disabled = false;
                downloadAllButton.disabled = false;
            }
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        // 1. ãƒ™ãƒ¼ã‚¹ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        imageUpload.addEventListener('change', (e) => {
            baseImages = Array.from(e.target.files);
            currentPreviewIndex = 0; // 0ç•ªç›®ã®ç”»åƒã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹
            
            if (baseImages.length > 0) {
                updatePreview();
                uploadStatus.classList.add('hidden');
            } else {
                updatePreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨UIè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                uploadStatus.textContent = 'ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
                uploadStatus.classList.remove('hidden');
            }
        });
        
        // 5. ç”»åƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        prevImageButton.addEventListener('click', () => {
            if (currentPreviewIndex > 0) {
                currentPreviewIndex--;
                updatePreview();
            }
        });

        nextImageButton.addEventListener('click', () => {
            if (currentPreviewIndex < baseImages.length - 1) {
                currentPreviewIndex++;
                updatePreview();
            }
        });

        // NEW: å˜ä½“ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
        downloadCurrentImageButton.addEventListener('click', downloadCurrentStampedImage);


        // 2. ãƒ­ã‚´ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        logoUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        loadedLogoImage = img;
                        addStampButton.disabled = false;
                        currentLogoStatus.textContent = `âœ… ãƒ­ãƒ¼ãƒ‰å®Œäº† (${img.width}x${img.height}px)`;
                        currentLogoStatus.classList.remove('hidden', 'text-red-500');
                        currentLogoStatus.classList.add('text-green-600');
                    };
                    img.onerror = () => {
                        currentLogoStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                        currentLogoStatus.classList.remove('hidden', 'text-green-600');
                        currentLogoStatus.classList.add('text-red-500');
                    }
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                loadedLogoImage = null;
                addStampButton.disabled = true;
                currentLogoStatus.classList.add('hidden');
            }
        });
        
        // 3. é…ç½®ãƒã‚¸ã‚·ãƒ§ãƒ³é¸æŠ
        positionButtons.querySelectorAll('.position-button').forEach(button => {
            button.addEventListener('click', (e) => {
                positionButtons.querySelectorAll('.position-button').forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                currentPosition = e.currentTarget.dataset.pos;
                updatePreview(); // ãƒã‚¸ã‚·ãƒ§ãƒ³å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            });
        });
        
        // 3. ã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ›´æ–°
        sizeRatioInput.addEventListener('input', (e) => {
            currentRatioSpan.textContent = `1/${e.target.value}`;
            updatePreview(); // ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        });
        
        // 3. ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
        addStampButton.addEventListener('click', () => {
            if (!loadedLogoImage) {
                currentLogoStatus.textContent = 'ãƒ­ã‚´ç”»åƒã‚’å…ˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
                currentLogoStatus.classList.remove('hidden', 'text-green-600');
                currentLogoStatus.classList.add('text-red-500');
                return;
            }

            const newStamp = {
                image: loadedLogoImage, // Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾æ ¼ç´
                position: currentPosition,
                ratio: parseInt(sizeRatioInput.value, 10)
            };
            
            activeStamps.push(newStamp);
            updateStampListUI();
            
            // ãƒ­ã‚´ç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¯ã‚¯ãƒªã‚¢ã—ã€æ¬¡ã®ãƒ­ã‚´ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã‚„ã™ãã™ã‚‹
            logoUpload.value = '';
            loadedLogoImage = null;
            addStampButton.disabled = true;
            currentLogoStatus.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—ãŒãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„ãƒ­ã‚´ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚';
            currentLogoStatus.classList.remove('text-red-500');
            currentLogoStatus.classList.add('text-green-600');
        });

        // ã‚¹ã‚¿ãƒ³ãƒ—ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢
        clearStampsButton.addEventListener('click', () => {
            activeStamps = [];
            updateStampListUI();
        });

        // 4. ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        downloadAllButton.addEventListener('click', async () => {
            if (baseImages.length === 0 || activeStamps.length === 0) {
                downloadProgress.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ãƒ™ãƒ¼ã‚¹ç”»åƒã¨ã‚¹ã‚¿ãƒ³ãƒ—è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚';
                downloadProgress.classList.remove('hidden');
                downloadAllButton.disabled = false;
                return;
            }

            downloadAllButton.disabled = true;
            downloadCurrentImageButton.disabled = true;
            downloadProgress.classList.remove('hidden');

            const zip = new JSZip();

            // ZIPãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«é©ç”¨ã™ã‚‹ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’äº‹å‰ã«è¨ˆç®—
            const stampCount = activeStamps.length;
            const stampSuffix = stampCount === 1 ? '_stamp' : (stampCount > 1 ? '_stamps' : '');

            for (let i = 0; i < baseImages.length; i++) {
                const file = baseImages[i];
                const fileName = file.name.replace(/\.[^/.]+$/, ""); // æ‹¡å¼µå­ãªã—ã®ãƒ•ã‚¡ã‚¤ãƒ«å

                downloadProgress.textContent = `â³ å‡¦ç†ä¸­: ${i + 1} / ${baseImages.length} æš...`;

                try {
                    const baseImg = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => resolve(img);
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });

                    // ä»®æƒ³Canvasã‚’ä½œæˆã—ã€åˆæˆå‡¦ç†ã‚’è¡Œã†
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCanvas.width = baseImg.width;
                    tempCanvas.height = baseImg.height;

                    // 1. ãƒ™ãƒ¼ã‚¹ç”»åƒã‚’å…¨é¢ã«æç”»
                    tempCtx.drawImage(baseImg, 0, 0, tempCanvas.width, tempCanvas.height);

                    // 2. ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é©ç”¨ (drawCanvasé–¢æ•°ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±æœ‰)
                    const stampsByPosition = {};
                    activeStamps.forEach(stamp => {
                        if (!stampsByPosition[stamp.position]) {
                            stampsByPosition[stamp.position] = [];
                        }
                        stampsByPosition[stamp.position].push(stamp);
                    });

                    Object.values(stampsByPosition).forEach(stamps => {
                        stamps.forEach((stamp, index) => {
                            const logoOriginalWidth = stamp.image.width;
                            const logoOriginalHeight = stamp.image.height;
                            
                            const dims = calculateLogoDimensions(
                                tempCanvas.width, 
                                tempCanvas.height, 
                                logoOriginalWidth, 
                                logoOriginalHeight, 
                                stamp.ratio
                            );
                            
                            const pos = calculatePosition(
                                tempCanvas.width, 
                                tempCanvas.height, 
                                dims, 
                                stamp.position, 
                                index 
                            );

                            tempCtx.drawImage(stamp.image, pos.x, pos.y, dims.width, dims.height);
                        });
                    });

                    // 3. ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Blobã¨ã—ã¦å–å¾—
                    const blob = await new Promise(resolve => {
                        tempCanvas.toBlob(resolve, 'image/jpeg', 0.9); // eBayå‘ã‘ã«JPEGã§åœ§ç¸®
                    });
                    
                    // 4. ZIPã«è¿½åŠ 
                    zip.file(`${fileName}${stampSuffix}.jpg`, blob);

                } catch (error) {
                    console.error(`ç”»åƒ ${file.name} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
                    downloadProgress.textContent = `âš ï¸ ã‚¨ãƒ©ãƒ¼: ç”»åƒ ${file.name} ã®å‡¦ç†ã«å¤±æ•—ã€‚`;
                }
            }

            // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            zip.generateAsync({ type: 'blob' })
                .then(function(content) {
                    const url = URL.createObjectURL(content);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ebay_stamped_images_${Date.now()}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    downloadProgress.textContent = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                    downloadAllButton.disabled = false;
                    downloadCurrentImageButton.disabled = false;
                })
                .catch(error => {
                    console.error('ZIPãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    downloadProgress.textContent = 'âŒ ZIPãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    downloadAllButton.disabled = false;
                    downloadCurrentImageButton.disabled = false;
                });
        });

        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’activeã«ã™ã‚‹
            document.querySelector(`.position-button[data-pos="${currentPosition}"]`).classList.add('active');
            // åˆæœŸçŠ¶æ…‹ã®ã‚µã‚¤ã‚ºæ¯”ç‡ã‚’è¡¨ç¤º
            currentRatioSpan.textContent = `1/${sizeRatioInput.value}`;
            
            // Canvasã®åˆæœŸã‚µã‚¤ã‚ºè¨­å®šï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦ï¼‰
            canvas.width = 600; 
            canvas.height = 450;
            ctx.fillStyle = '#f7f7f7';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // åˆæœŸãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            updatePreview(); 
        });
        
    </script>
</body>
</html>
